@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@Html.AntiForgeryToken()

<table class="table">
	<tr>
		<td>
			<h1>ToDo List</h1>
		</td>
		<td>
			<!-- class="justify-content-center" -->

			<button class="btn btn-primary btn-sm m-1" type="button"
					data-bs-toggle="collapse"
					data-bs-target="#CreateNewToDoListArea">
				Create New ToDo List
			</button>

		</td>
	</tr>
</table>

<div id="CreateNewToDoListArea" class="card collapse m-1">
	<div class="card-header">
		Create New ToDo List
	</div>
	<div class="card-body">
		<form asp-action="CreateNewToDoList" method="post" class="form-control ">

			<div class="col form-group m-2">
				<input type="text" id="toDoListTitle" name="toDoListTitle" value="" placeholder="Name of new ToDoList" required class="form-control">
			</div>
			<div class="col form-group m-2">
				<input type="text" id="toDoListDesc" name="toDoListDesc" value="" placeholder="Describtion of new ToDoList" required class="form-control">
			</div>
			<div class="col form-group m-2">
				<button class="btn btn-primary" type="submit">Save</button>
				<button class="btn btn-warning" type="button"
						data-bs-toggle="collapse"
						data-bs-target="#CreateNewToDoListArea">
					Cancel
				</button>
			</div>

		</form>
	</div>
</div>
<hr />

<table class="table">
	<thead>
	<th>ToDo List</th>
	<th>Achtions</th>
	</thead>
	<tbody>
		@foreach (var todoList in ViewBag.ToDoLists)
		{
			<tr>
				<td>
					<div class="accordion m-2" id="accordionId_@todoList.Id">
						<div class="accordion-item ">
							<h2 class="accordion-header" id="heading_@todoList.Id">
								@* <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_@todoList.Id"
						aria-expanded="true" aria-controls="collapse_@todoList.Id">
					<strong>@todoList.Id - @todoList.ListTitle</strong>
				</button> *@

								<button class="accordion-button collapsed"
										type="button"
										data-bs-toggle="collapse"
										data-bs-target="#collapse_@todoList.Id"
										aria-expanded="false"
										aria-controls="collapse_@todoList.Id"
										data-todoid="@todoList.Id">
									<strong>@todoList.Id - @todoList.ListTitle</strong>
								</button>


							</h2>


							<div id="collapse_@todoList.Id" class="accordion-collapse collapse" aria-labelledby="heading_@todoList.Id" data-bs-parent="#accordion_@todoList.Id">
								<div class="accordion-body">
									@todoList.ListDescription
								</div>
								<div class="card mb-3">

									<div class="card-body">
										<!-- #region: ToDoItem -->
										<table class="table table-light table-striped table-hover">
											<thead>
											<th>Done?</th>
											<th>ToDo</th>
											<th>Actions</th>
											</thead>
											<tbody>

												@foreach (var todoItem in todoList.Items)
												{
													<tr>
														<td class="align-content-center align-items-center">
															<input type="checkbox" id="@todoItem.Id" name="todoItemId" value="@todoItem.IsCompleted" class="form-check-input todo-checkbox" data-id="@todoItem.Id" @(todoItem.IsCompleted ? "checked" : "")>
														</td>
														<td>
															<div id="readToDoItemText_@todoItem.Id">
																@todoItem.ItemTitle
															</div>
															<!-- #region: versteckter Edit-Bereich -->
															<div id="editToDoItemText_@todoItem.Id" style="display:none;">
																<form asp-action="EditToDoItem" method="post" class="form-control d-flex flex-row">
																	<input id="toDoItemId" name="toDoItemId" type="hidden" value="@todoItem.Id">
																	<input id="tbxToDoText_@todoItem.Id" name="txbToDoText" type="text" value="@todoItem.ItemTitle" class="m-1" />
																	<button class="btn btn-sm btn-primary m-1" type="submit">Save</button>
																	<button class="btn btn-sm btn-warning m-1" type="button" onclick="cancelEditToDoItemText(@todoItem.Id)">
																		Cancel
																	</button>
																</form>
															</div>
															<!-- #endregion: versteckter Edit-Bereich -->
														</td>
														<td>
															<div class="row">
																<div class="col">

																	<button type="button" class="btn btn-warning m-1" onclick="toggleDiv('readToDoItemText_@todoItem.Id','editToDoItemText_@todoItem.Id')">
																		Edit
																	</button>

																</div>
																<div class="col">
																	<form asp-action="DeleteToDoItem" asp-route-id="@todoItem.Id">
																		<button type="submit" class="btn btn-danger">Delete</button>
																	</form>
																</div>
															</div>
														</td>
													</tr>
												}

											</tbody>
										</table>
										<!-- #endregion: ToDoItem -->
									</div>

									<div id="CreateNewToDoItemArea_@todoList.Id" class="collapse card-body">
										<form asp-action="CreateNewToDoItem" method="post" class="form-control ">

											<div class="col form-group m-2">
												<input type="hidden" id="toDoListId" name="toDoListId" value="@todoList.Id">
											</div>
											<div class="col form-group m-2">
												<input type="text" id="toDoText" name="toDoText" value="" placeholder="New ToDo" required class="form-control">
											</div>
											<div class="col form-group m-2">
												<button class="btn btn-primary" type="submit">Save</button>
												<button class="btn btn-warning" type="button"
														data-bs-toggle="collapse"
														data-bs-target="#CreateNewToDoItemArea_@todoList.Id">
													Cancel
												</button>
											</div>

										</form>
									</div>

									<div class="card-footer">
										<button id="btnAddNewTask_@todoList.Id" class="btn btn-primary" type="button"
												data-bs-toggle="collapse"
												data-bs-target="#CreateNewToDoItemArea_@todoList.Id">
											Add New Task
										</button>


									</div>
								</div>
							</div>
						</div>

					</div>

					<!-- #region: edit -->
					<!-- #region: versteckter Edit-Bereich fuer ToDoList -->
					<div id="editToDoListTitle_@todoList.Id" style="display:none;">
						<div class="card mb-3">
							<div class="card-header">
								Edit ToDoList
							</div>

							<form asp-action="EditToDoList" method="post" class="form-control d-flex flex-row">
								<div class="card-body">
									<input id="toDoListTitleId" name="toDoListTitleId" type="hidden" value="@todoList.Id">
									<label class="label form-label  col-form-label-sm">Title:</label>
									<div><input id="tbxToDoListTitle_@todoList.Id" name="tbxToDoTitle" type="text" value="@todoList.ListTitle" class="m-1" /></div>
									<label class="label form-label col-form-label-sm">Description:</label>
									<div><input id="tbxToDoListDescription_@todoList.Id" name="tbxToDoDescription" type="text" value="@todoList.ListDescription" class="m-1" size="50" /></div>
									<button class="btn btn-sm btn-primary m-1" type="submit">Save</button>
									<button class="btn btn-sm btn-warning m-1" type="button" onclick="toggleDiv('accordionId_@todoList.Id','editToDoListTitle_@todoList.Id')">
										<!-- onclick="cancelEditToDoItemText(@todoList.Id)" -->
										Cancel
									</button>
								</div>
								@* <div class="card-footer">
					
				</div> *@

							</form>
						</div>
					</div>
					<!-- #endregion: versteckter Edit-Bereich fuer ToDoList -->
					<!-- #endregion: edit -->
				</td>
				<td>
					<!-- Edit Button -->
					<button type="button" class="btn btn-warning m-1" onclick="toggleDiv('accordionId_@todoList.Id', 'editToDoListTitle_@todoList.Id')">
						Edit 🖉
					</button>
					<!-- Delete Button -->
					<form asp-action="DeleteToDoList" asp-route-id="@todoList.Id">
						<button type="submit" class="btn btn-danger">Delete</button>
					</form>
				</td>
			</tr>
		}

	</tbody>


</table>
<!-- #region: javascript -->
<script>

	function toggleDiv(readToDoItemText, editToDoItemText) {
		@* console.log("toggleDiv(id): " + id); *@
		@* var readToDoItemText = "readToDoItemText_" + id; *@
		@* var editToDoItemText = "editToDoItemText_" + id; *@
		console.log("readToDoItemText: " + readToDoItemText);
		console.log("editToDoItemText: " + editToDoItemText);
		const readDiv = document.getElementById(readToDoItemText);
		const editDiv = document.getElementById(editToDoItemText);

		readDiv.style.display = (readDiv.style.display === "none") ? "block" : "none";
		editDiv.style.display = (editDiv.style.display === "none") ? "block" : "none";
	}

	function cancelEditToDoItemText(id){
		@* console.log("cancelEditToDoItemText(id): " + id); *@
		var readToDoItemText = "readToDoItemText_" + id;
		@* console.log("readToDoItemText: " + readToDoItemText);
		console.log("editToDoItemText: " + editToDoItemText); *@

		var toDoItemText = document.getElementById(readToDoItemText).innerText;
		@* console.log("toDoItemText: " + toDoItemText); *@
		var inputId = "tbxToDoText_" + id;
		@* console.log("inputId: " + inputId); *@
		const input = document.getElementById(inputId)
		@* console.log("input: " + input.value); *@

		if(input)
		{
			input.value = toDoItemText.trim();
		}
		else{
			console.log("cancelEditToDoItemText(id): " + id + " | input failed");
		}

		toggleDiv(readToDoItemText, 'editToDoItemText_' + id);
	}
	@* ------------------------------------------------------------ *@
	document.querySelectorAll(".todo-checkbox").forEach(cb => {
		cb.addEventListener("change", function () {

			const todoId = this.dataset.id;
			const isDone = this.checked;

			fetch('/ToDo/UpdateStatus', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'RequestVerificationToken':
						document.querySelector('input[name="__RequestVerificationToken"]').value
				},
				body: JSON.stringify({
					id: todoId,
					isDone: isDone
				})
			})
			.then(response => {
				if (!response.ok) {
					alert("Fehler beim Speichern");
				}
			});
		});
	});
	@* ------------------------------------------------------------ *@
	@* // Wenn Accordion geoeffnet wird → ID merken *@
	document.querySelectorAll(".accordion-button").forEach(btn => {
		btn.addEventListener("click", function () {
			const todoId = this.dataset.todoid;
			if (todoId) {
				localStorage.setItem("openToDoListId", todoId);
			}
		});
	});

	@* // Nach Seitenreload → Accordion wieder oeffnen *@
	document.addEventListener("DOMContentLoaded", function () {
		const openId = localStorage.getItem("openToDoListId");
		if (!openId) return;

		const collapseEl = document.getElementById("collapse_" + openId);
		const buttonEl = document.querySelector(
			`[data-bs-target="#collapse_${openId}"]`
		);

		if (collapseEl && buttonEl) {
			const bsCollapse = new bootstrap.Collapse(collapseEl, {
				toggle: false
			});
			bsCollapse.show();

			buttonEl.classList.remove("collapsed");
			buttonEl.setAttribute("aria-expanded", "true");
		}
	});
</script>
<!-- #endregion: javascript -->


<hr />



